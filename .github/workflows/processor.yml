name: Akcio Vadasz Feldolgozo (AI + OCR)

on:
  workflow_dispatch:  # K√©zi ind√≠t√°s lehet≈ës√©ge (Tesztel√©shez)
  workflow_run:       # Automata ind√≠t√°s, HA a Linkvad√°sz v√©gzett
    workflows: ["Akcios Ujsag Linkvadasz (Automata)"]
    types:
      - completed

permissions:
  contents: write

jobs:
  process_flyers:
    runs-on: ubuntu-latest
    # Csak akkor fusson, ha az el≈ëz≈ë robot SIKERES volt (vagy ha k√©zzel ind√≠tottad)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: K√≥d let√∂lt√©se
        uses: actions/checkout@v4

      - name: Python telep√≠t√©se
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Sz√ºks√©ges programok telep√≠t√©se
        run: |
          pip install requests beautifulsoup4 selenium webdriver-manager openai google-cloud-vision python-dotenv curl_cffi

      - name: Google Chrome telep√≠t√©se (A fot√≥z√°shoz)
        uses: browser-actions/setup-chrome@latest

      - name: Titkos Google Kulcs l√©trehoz√°sa
        env:
          GOOGLE_KEY_CONTENT: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}
        run: |
          # A titkos sz√∂vegb≈ël f√°jlt csin√°lunk, mert a Python ezt keresi
          echo "$GOOGLE_KEY_CONTENT" > google_key.json

      - name: ü§ñ Akci√≥vad√°sz Robot Ind√≠t√°sa (2 oldal/√∫js√°g teszt)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS: google_key.json
        run: python flyer_processor_bot.py

      - name: Eredm√©ny ment√©se (Git Commit)
        run: |
          git config --global user.name "AkcioVadaszBot"
          git config --global user.email "bot@akciovadasz.hu"
          # Hozz√°adjuk a gener√°lt JSON-t
          git add universal_output.json
          # Ha van v√°ltoz√°s, elmentj√ºk. Ha nincs, nem s√≠runk.
          git commit -m "√öj term√©kek feldolgozva (AI) - $(date)" || echo "Nincs √∫j adat, nem kell menteni."
          git push
